// jQuery List DragSort v0.5.0
// License: http://dragsort.codeplex.com/license
(function(b){b.fn.dragsort=function(k){if("destroy"==k)b(this.selector).trigger("dragsort-uninit");else{var d=b.extend({},b.fn.dragsort.defaults,k),i=[],a=null,l=null;this.each(function(m,j){b(j).is("table")&&1==b(j).children().size()&&b(j).children().is("tbody")&&(j=b(j).children().get(0));var k={draggedItem:null,placeHolderItem:null,pos:null,offset:null,offsetLimit:null,scroll:null,container:j,init:function(){var a=0==b(this.container).children().size()?"li":b(this.container).children(":first").get(0).tagName.toLowerCase(); if(""==d.itemSelector)d.itemSelector=a;if(""==d.dragSelector)d.dragSelector=a;if(""==d.placeHolderTemplate)d.placeHolderTemplate="<"+a+">&nbsp;</"+a+">";b(this.container).attr("data-listidx",m).mousedown(this.grabItem).bind("dragsort-uninit",this.uninit);this.getItems().each(function(a){b(this).attr("data-itemidx",a)});this.styleDragHandlers(!0)},uninit:function(){var a=i[b(this).attr("data-listidx")];b(a.container).unbind("mousedown",a.grabItem).unbind("dragsort-uninit");a.styleDragHandlers(!1)}, getItems:function(){return b(this.container).children(d.itemSelector)},styleDragHandlers:function(a){this.getItems().map(function(){return b(this).is(d.dragSelector)?this:b(this).find(d.dragSelector).get()}).css("cursor",a?"pointer":"")},grabItem:function(a){if(!(1!=a.which||b(a.target).is(d.dragSelectorExclude)||0<b(a.target).closest(d.dragSelectorExclude).size()||0==b(a.target).closest(d.itemSelector).size())){a.preventDefault();for(var c=a.target;!b(c).is(d.dragSelector);){if(c==this)return;c= c.parentNode}b(c).attr("data-cursor",b(c).css("cursor"));b(c).css("cursor","move");var f=i[b(this).attr("data-listidx")],g=this,h=function(){f.dragStart.call(g,a);b(f.container).unbind("mousemove",h)};b(f.container).mousemove(h).mouseup(function(){b(f.container).unbind("mousemove",h);b(c).css("cursor",b(c).attr("data-cursor"))})}},dragStart:function(e){null!=a&&null!=a.draggedItem&&a.dropItem();a=i[b(this).attr("data-listidx")];a.draggedItem=b(e.target).closest(d.itemSelector);var c=parseInt(a.draggedItem.css("marginTop")), f=parseInt(a.draggedItem.css("marginLeft"));a.offset=a.draggedItem.offset();a.offset.top=e.pageY-a.offset.top+(isNaN(c)?0:c)-1;a.offset.left=e.pageX-a.offset.left+(isNaN(f)?0:f)-1;if(!d.dragBetween)c=0==b(a.container).outerHeight()?Math.max(1,Math.round(0.5+a.getItems().size()*a.draggedItem.outerWidth()/b(a.container).outerWidth()))*a.draggedItem.outerHeight():b(a.container).outerHeight(),a.offsetLimit=b(a.container).offset(),a.offsetLimit.right=a.offsetLimit.left+b(a.container).outerWidth()-a.draggedItem.outerWidth(), a.offsetLimit.bottom=a.offsetLimit.top+c-a.draggedItem.outerHeight();c=a.draggedItem.height();f=a.draggedItem.width();"td"==d.itemSelector?a.placeHolderItem=a.draggedItem.attr("data-placeholder",!0):"tr"==d.itemSelector?(a.draggedItem.children().each(function(){b(this).width(b(this).width())}),a.placeHolderItem=a.draggedItem.clone().attr("data-placeholder",!0),a.draggedItem.after(a.placeHolderItem),a.placeHolderItem.children().each(function(){b(this).css({borderWidth:0,width:b(this).width()+1,height:b(this).height()+ 1}).html("&nbsp;")})):(a.draggedItem.after(d.placeHolderTemplate),a.placeHolderItem=a.draggedItem.next().css({height:c,width:f}).attr("data-placeholder",!0));var g=a.draggedItem.attr("style");a.draggedItem.attr("data-origstyle",g?g:"");a.draggedItem.css({position:"absolute",opacity:0.8,"z-index":999,height:c,width:f});a.scroll={moveX:0,moveY:0,maxX:b(document).width()-b(window).width(),maxY:b(document).height()-b(window).height()};a.scroll.scrollY=window.setInterval(function(){if(d.scrollContainer!= window)b(d.scrollContainer).scrollTop(b(d.scrollContainer).scrollTop()+a.scroll.moveY);else{var c=b(d.scrollContainer).scrollTop();if(0<a.scroll.moveY&&c<a.scroll.maxY||0>a.scroll.moveY&&0<c)b(d.scrollContainer).scrollTop(c+a.scroll.moveY),a.draggedItem.css("top",a.draggedItem.offset().top+a.scroll.moveY+1)}},10);a.scroll.scrollX=window.setInterval(function(){if(d.scrollContainer!=window)b(d.scrollContainer).scrollLeft(b(d.scrollContainer).scrollLeft()+a.scroll.moveX);else{var c=b(d.scrollContainer).scrollLeft(); if(0<a.scroll.moveX&&c<a.scroll.maxX||0>a.scroll.moveX&&0<c)b(d.scrollContainer).scrollLeft(c+a.scroll.moveX),a.draggedItem.css("left",a.draggedItem.offset().left+a.scroll.moveX+1)}},10);b(i).each(function(a,b){b.createDropTargets();b.buildPositionTable()});a.setPos(e.pageX,e.pageY);b(document).bind("mousemove",a.swapItems);b(document).bind("mouseup",a.dropItem);d.scrollContainer!=window&&b(window).bind("DOMMouseScroll mousewheel",a.wheel)},setPos:function(e,c){var f=c-this.offset.top,g=e-this.offset.left; d.dragBetween||(f=Math.min(this.offsetLimit.bottom,Math.max(f,this.offsetLimit.top)),g=Math.min(this.offsetLimit.right,Math.max(g,this.offsetLimit.left)));this.draggedItem.parents().each(function(){if("static"!=b(this).css("position")&&(!b.browser.mozilla||"table"!=b(this).css("display"))){var a=b(this).offset();f-=a.top;g-=a.left;return!1}});if(d.scrollContainer==window)c-=b(window).scrollTop(),e-=b(window).scrollLeft(),c=Math.max(0,c-b(window).height()+5)+Math.min(0,c-5),e=Math.max(0,e-b(window).width()+ 5)+Math.min(0,e-5);else var h=b(d.scrollContainer),i=h.offset(),c=Math.max(0,c-h.height()-i.top)+Math.min(0,c-i.top),e=Math.max(0,e-h.width()-i.left)+Math.min(0,e-i.left);a.scroll.moveX=0==e?0:e*d.scrollSpeed/Math.abs(e);a.scroll.moveY=0==c?0:c*d.scrollSpeed/Math.abs(c);this.draggedItem.css({top:f,left:g})},wheel:function(e){if((b.browser.safari||b.browser.mozilla)&&a&&d.scrollContainer!=window){var c=b(d.scrollContainer),f=c.offset();e.pageX>f.left&&e.pageX<f.left+c.width()&&e.pageY>f.top&&e.pageY< f.top+c.height()&&(f=e.detail?5*e.detail:e.wheelDelta/-2,c.scrollTop(c.scrollTop()+f),e.preventDefault())}},buildPositionTable:function(){var a=null==this.draggedItem?null:this.draggedItem.get(0),c=[];this.getItems().each(function(d,g){if(g!=a){var h=b(g).offset();h.right=h.left+b(g).width();h.bottom=h.top+b(g).height();h.elm=g;c.push(h)}});this.pos=c},dropItem:function(){if(null!=a.draggedItem){var e=a.draggedItem.attr("data-origstyle");a.draggedItem.attr("style",e);""==e&&a.draggedItem.removeAttr("style"); a.draggedItem.removeAttr("data-origstyle");a.styleDragHandlers(!0);"td"!=d.itemSelector&&(a.placeHolderItem.before(a.draggedItem),a.placeHolderItem.remove());b("[data-droptarget]").remove();window.clearInterval(a.scroll.scrollY);window.clearInterval(a.scroll.scrollX);var c=!1;b(i).each(function(){this.getItems().each(function(a){parseInt(b(this).attr("data-parentidx"))!=m&&(c=!0,b(this).attr("data-parentidx",m));parseInt(b(this).attr("data-itemidx"))!=a&&(c=!0,b(this).attr("data-itemidx",a))})}); c&&d.dragEnd.apply(a.draggedItem);a.draggedItem=null;b(document).unbind("mousemove",a.swapItems);b(document).unbind("mouseup",a.dropItem);d.scrollContainer!=window&&b(window).unbind("DOMMouseScroll mousewheel",a.wheel);return!1}},swapItems:function(e){if(null==a.draggedItem)return!1;a.setPos(e.pageX,e.pageY);for(var c=a.findPos(e.pageX,e.pageY),f=a,g=0;-1==c&&d.dragBetween&&g<i.length;g++)c=i[g].findPos(e.pageX,e.pageY),f=i[g];if(-1==c||b(f.pos[c].elm).attr("data-placeholder"))return!1;var h=function(){return b(f.container).children().not(f.draggedItem)}, e=h().not(d.itemSelector).each(function(){this.idx=h().index(this)});null==l||l.top>a.draggedItem.offset().top||l.left>a.draggedItem.offset().left?b(f.pos[c].elm).before(a.placeHolderItem):b(f.pos[c].elm).after(a.placeHolderItem);e.each(function(){var a=h().eq(this.idx).get(0);this!=a&&h().index(this)<this.idx?b(this).insertAfter(a):this!=a&&b(this).insertBefore(a)});b(i).each(function(a,b){b.createDropTargets();b.buildPositionTable()});l=a.draggedItem.offset();return!1},findPos:function(a,b){for(var d= 0;d<this.pos.length;d++)if(this.pos[d].left<a&&this.pos[d].right>a&&this.pos[d].top<b&&this.pos[d].bottom>b)return d;return-1},createDropTargets:function(){d.dragBetween&&b(i).each(function(){var e=b(this.container).find("[data-placeholder]"),c=b(this.container).find("[data-droptarget]");0<e.size()&&0<c.size()?c.remove():0==e.size()&&0==c.size()&&("td"==d.itemSelector?b(d.placeHolderTemplate).attr("data-droptarget",!0).appendTo(this.container):b(this.container).append(a.placeHolderItem.removeAttr("data-placeholder").clone().attr("data-droptarget", !0)),a.placeHolderItem.attr("data-placeholder",!0))})}};k.init();i.push(k)});return this}};b.fn.dragsort.defaults={itemSelector:"",dragSelector:"",dragSelectorExclude:"input, textarea",dragEnd:function(){},dragBetween:!1,placeHolderTemplate:"",scrollContainer:window,scrollSpeed:5}})(jQuery);
/*
 *      jquery.kalendar.js v1.0
 *
 *      Copyright 2011 Ismael Rodríguez <el.quick@gmail.com>
 *
 *      This program is free software; you can redistribute it and/or modify
 *      it under the terms of the GNU General Public License as published by
 *      the Free Software Foundation; either version 2 of the License, or
 *      (at your option) any later version.
 *
 *      This program is distributed in the hope that it will be useful,
 *      but WITHOUT ANY WARRANTY; without even the implied warranty of
 *      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *      GNU General Public License for more details.
 *
 *      You should have received a copy of the GNU General Public License
 *      along with this program; if not, write to the Free Software
 *      Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 *      MA 02110-1301, USA.
 */
(function($){$.fn.kalendar=function(options){var defaults={show_week_number:false,hover_full_week:false,week_start_on_monday:false,close_on_pick:true,open_effect:"fadeIn",close_effect:"fadeOut",format:"%Y-%m-%d",show_year_control:false,start_year:false,stop_year:false,months_name:["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"],short_months_name:["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],days_name:["Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado"],short_days_name:["Do","Lu","Ma","Mi","Ju","Vi","Sá"],show_other_months:true};var $settings=$.extend({},defaults,options);if($settings.week_start_on_monday){$settings.days_name[$settings.days_name.length]=$settings.days_name[0];$settings.short_days_name[$settings.short_days_name.length]=$settings.short_days_name[0];$settings.days_name.splice(0,1);$settings.short_days_name.splice(0,1)}if($settings.start_year==false){$settings.start_year=(new Date().getFullYear())-10}if($settings.stop_year==false){$settings.stop_year=(new Date().getFullYear())+10}Date.prototype.getWeek=function(week_start_on_monday){var onejan=new Date(this.getFullYear(),0,1);return Math.ceil((((this-onejan)/86400000)+onejan.getDay()+(week_start_on_monday?0:1))/7)};Date.prototype.eql=function(compare){return(this.getDate()==compare.getDate()&&this.getMonth()==compare.getMonth()&&this.getFullYear()==compare.getFullYear())};Date.prototype.eqlDayMonth=function(compare){return(this.getMonth()==compare.getMonth()&&this.getFullYear()==compare.getFullYear())};this.each(function(){var elem=$(this);elem.kalendar=false;elem.curdate=false;elem.skalendar=false;elem.click(function(e){if(elem.curdate==false){var datefinput=format2date(elem.val());if(datefinput!==false&&datefinput instanceof Date&&isFinite(datefinput)){elem.curdate=datefinput}else{elem.curdate=new Date()}}if(elem.kalendar==false){elem.kalendar=createKalendar();initActions()}if(!elem.skalendar){elem.kalendar.hide();$("body").append(elem.kalendar);elem.kalendar[$settings.open_effect]("fast",function(){$(document).bind("click",closeOnBody);elem.skalendar=true})}else{e.stopPropagation()}});function closeOnBody(){elem.kalendar[$settings.close_effect]("fast",function(){elem.skalendar=false});$(document).unbind("click",closeOnBody)}function createYearControl(){if(typeof elem.kalendar.year_control==="undefined"){var year_control=$("<select />");for(var i=$settings.start_year;i<$settings.stop_year;i++){year_control.append($("<option />").val(i).text(i))}}else{year_control=elem.kalendar.year_control}year_control.val(elem.curdate.getFullYear());return year_control}function initYearControl(){if($settings.show_year_control){elem.kalendar.year_control.click(function(e){e.stopPropagation()});elem.kalendar.year_control.change(function(){elem.curdate.setYear($(this).val());fillKalendar()})}}function createMonthControl(){if(typeof elem.kalendar.month_control==="undefined"){var month_control=$("<select />");for(var i=0;i<$settings.months_name.length;i++){month_control.append($("<option />").val(i).text($settings.months_name[i]))}}else{month_control=elem.kalendar.month_control}month_control.val(elem.curdate.getMonth());return month_control}function parse2format(date){var str=$settings.format;str=str.replace("%d",(date.getDate()<10?('0'+date.getDate()):date.getDate()));str=str.replace("%D",$settings.short_days_name[date.getDay()]);str=str.replace("%l",$settings.days_name[date.getDay()]);str=str.replace("%W",date.getWeek($settings.week_start_on_monday));str=str.replace("%F",$settings.months_name[date.getMonth()]);str=str.replace("%m",((date.getMonth()+1)<10?('0'+(date.getMonth()+1)):date.getMonth()+1));str=str.replace("%M",$settings.short_months_name[date.getMonth()]);str=str.replace("%Y",date.getFullYear());return str}function format2date(val){val=val.toUpperCase();var day=false;var month=false;var year=false;var format=$settings.format;if(format.indexOf("%F")!=-1){var found=false;for(var f in $settings.months_name){if(val.replace($settings.months_name[f].toUpperCase(),"")!=val){var month=f;val=val.replace($settings.months_name[f].toUpperCase(),"");found=true;break}}if(!found){console.warn("Atención! verifica lo siguiente:\nSegún el formato deseado \"("+$settings.format+")\", especificamente en \"%F\" se esperaba en el \"value\" del control (input) uno de los siguientes meses: \n"+$settings.months_name.join("\n")+".")}}if(month===false){if(format.indexOf("%M")!=-1){var found=false;for(var m in $settings.short_months_name){if(val.replace($settings.short_months_name[m].toUpperCase(),"")!=val){var month=m;val=val.replace($settings.short_months_name[m].toUpperCase(),"");found=true;break}}if(!found){console.warn("Atención! verifica lo siguiente:\nSegún el formato deseado \"("+$settings.format+")\", especificamente en \"%M\" se esperaba en el \"value\" del control (input) uno de los siguientes meses: \n"+$settings.short_months_name.join("\n")+".")}}}val=val.replace(/[^0-9]/g," ").replace(/ +(?= )/g,"").replace(/^\s+/g,'').replace(/\s+$/g,'');var matches=format.match(/(%d|%m|%Y|%W)/g);format=matches.join(" ");var splitted_val=val.split(" ");var splitted_format=format.split(" ");for(var i=0;i<splitted_format.length;i++){switch(splitted_format[i]){case"%d":day=splitted_val[i];break;case"%m":month=splitted_val[i]-1;break;case"%Y":year=splitted_val[i];break}}if(day!==false&&typeof day!=="undefined"&&month!==false&&typeof month!=="undefined"&&year!==false&&typeof year!=="undefined")return new Date(year,month,day);console.warn("Atención!\nSe intentó poner la fecha en el calendario según el control \"<input>\" pero no se consiguió.\nAl parecer el \"value\" del input no respeta el formato especificado: \"("+$settings.format+")\" en la configuración del plugin.");return false}function weekDayNumber(day,month,year){var date_obj=new Date(year,month,day);return date_obj.getDay()}function createHeader(){var header=$("<table />",{class:"header"});var tr=$("<tr />");for(var i=0;i<3;i++){var td=$("<td />",{class:(i==0?'back':(i==1?'center':'next'))});td.append($("<a />"));tr.append(td)}header.append(tr);return header}function fillHeader(){if($settings.show_year_control){elem.kalendar.month_control=createMonthControl();elem.kalendar.header.find("td.center").append(elem.kalendar.month_control);elem.kalendar.year_control=createYearControl();elem.kalendar.header.find("td.center").append(elem.kalendar.year_control)}else{elem.kalendar.header.find("td.center").text($settings.months_name[elem.curdate.getMonth()]+" "+elem.curdate.getFullYear())}}function createKalendar(){var kalendar=$("<div />",{class:'kalendar',style:'position: absolute; top: '+(elem.offset().top+elem.height())+'px; left: '+elem.offset().left+'px'});kalendar.header=createHeader();kalendar.append(kalendar.header);kalendar.grid=createKalendarGrid();kalendar.append(kalendar.grid);kalendar.days_header=createDaysHeader();kalendar.grid.append(kalendar.days_header);return kalendar}function initActions(){fillHeader();fillKalendar();initDayClick();initHover();initMonthControl();initYearControl()}function createDaysHeader(){var thead=$("<thead />");var tr=$("<tr />");if($settings.show_week_number){tr.append($("<th />").addClass("wk"))}for(var i=0;i<$settings.short_days_name.length;i++){var th=$("<th />");th.text($settings.short_days_name[i]);tr.append(th)}thead.append(tr);return thead}function createKalendarGrid(){kalendar=$("<table />",{class:"grid"});for(var i=0;i<5;i++){tr=$("<tr />");if($settings.show_week_number){tr.append($("<td />").addClass("wk"))}for(var j=0;j<$settings.short_days_name.length;j++){tr.append($("<td />"))}kalendar.append(tr)}return kalendar}function fillKalendar(){var cursor=new Date(elem.curdate.getFullYear(),elem.curdate.getMonth(),elem.curdate.getDate());if(weekDayNumber(1,cursor.getMonth(),cursor.getFullYear())==0){cursor.setDate(1)}else{var dummy=new Date(cursor.getFullYear(),cursor.getMonth(),0);dummy.setDate(dummy.getDate()-weekDayNumber(dummy.getDate(),dummy.getMonth(),dummy.getFullYear()));cursor=dummy}if($settings.week_start_on_monday){cursor.setDate(cursor.getDate()+1)}elem.kalendar.grid.find("td").removeClass("today month other");elem.kalendar.grid.find("td").each(function(){if($(this).hasClass("wk")){$(this).text(cursor.getWeek($settings.week_start_on_monday));$(this).data("date",{"year":cursor.getFullYear(),"month":cursor.getMonth(),"day":cursor.getDate(),"week":cursor.getWeek($settings.week_start_on_monday)});return true}$(this).text(cursor.getDate());if(cursor.eql(elem.curdate)){$(this).addClass("today");if($settings.hover_full_week){$(this).closest("tr").find("td").addClass("today")}}else if(cursor.eqlDayMonth(elem.curdate)){$(this).addClass("month")}else{$(this).addClass("other")}$(this).data("date",{"year":cursor.getFullYear(),"month":cursor.getMonth(),"day":cursor.getDate(),"week":cursor.getWeek($settings.week_start_on_monday)});cursor.setDate(cursor.getDate()+1)})}function initDayClick(){if($settings.hover_full_week){var elements=elem.kalendar.grid.find("td")}else{var elements=elem.kalendar.grid.find("td[class!=wk]")}elements.click(function(e){elem.curdate=new Date($(this).data("date").year,$(this).data("date").month,$(this).data("date").day);fillHeader();fillKalendar();elem.val(parse2format(elem.curdate));if($settings.close_on_pick){elem.kalendar[$settings.close_effect]()}else{e.stopPropagation()}})}function initHover(){if($settings.hover_full_week){elem.kalendar.grid.find("tr").hover(function(){$(this).find("td").addClass("hover")},function(){$(this).find("td").removeClass("hover")})}else{elem.kalendar.grid.find("td[class!=wk]").hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")})}}function initMonthControl(){if($settings.show_year_control){elem.kalendar.month_control.click(function(e){e.stopPropagation()});elem.kalendar.month_control.change(function(e){elem.curdate.setMonth($(this).val());fillKalendar()})}elem.kalendar.header.find("td.back a").click(function(e){elem.curdate.setMonth(elem.curdate.getMonth()-1);fillHeader();fillKalendar();e.stopPropagation()});elem.kalendar.header.find("td.next a").click(function(e){elem.curdate.setMonth(elem.curdate.getMonth()+1);fillHeader();fillKalendar();e.stopPropagation()})}});return this}})(jQuery);